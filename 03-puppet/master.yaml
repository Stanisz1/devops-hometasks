- name: master
  become: yes
  hosts: all

  tasks:
    - name: install sshpass
      become: yes
      yum:
        name: sshpass
        state: present

    - name: disable key check
      become: yes
      ini_file:
        path: /etc/ansible/ansible.cfg
        section: defaults
        option: host_key_checking
        value: False

    - name: playbook for master
      copy:
        src: /vagrant/master.yaml
        dest: /home/vagrant/master.yaml

    - name: inventory for all
      copy:
        src: /vagrant/inventory.yaml
        dest: /home/vagrant/inventory.yaml

- name: install  master
  become: yes
  hosts: localhost

  tasks:

    - name: Check if puppet6 repo is already installed
      shell: dnf repoinfo puppet6
      register: repo_check
      ignore_errors: true
      
    - name: Disable puppet6 repo if it exists
      ini_file:
        dest: /etc/yum.repos.d/puppet6.repo
        section: 'puppet6'
        option: 'enabled'
        value: '0'
      when: repo_check.rc == 0
    
    - name: Install puppetserver and add repositories if puppet6 repo does not exist
      block:
        - name: Add EPEL repo to master
          dnf:
            name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
            state: present
          
        - name: Add Puppet Labs repo to master
          dnf:
            name: https://yum.puppetlabs.com/puppet-release-el-8.noarch.rpm
            state: present
          
        - name: Install puppetserver
          yum:
            name: puppetserver
            state: latest
      when: repo_check.rc != 0 and ansible_pkg_mgr == "dnf"
    


    - name: stop firewalld
      service:
        name: firewalld
        state: stopped

    - name: add hosts slave1 and slave2
      lineinfile:
        path: /etc/hosts
        regexp: '^192\.168\.33\.1[12].*$'
        line: '{{ item }} slave{{ loop.index }}.puppet'
      loop:
        - '192.168.33.11'
        - '192.168.33.12'

    - name: install r10k
      command: '/opt/puppetlabs/puppet/bin/gem install r10k'
      become: true

    - name: resize memory
      lineinfile:
        path: /etc/sysconfig/puppetserver
        regexp: '^JAVA_ARGS.*$'
        line: 'JAVA_ARGS="-Xms256m -Xmx256m"'
      become: true

    - name: add puppet.config
      lineinfile:
        path: /etc/puppetlabs/puppet/puppet.conf
        regexp: '^#?[\s]*server = .*$'
        line: 'server = master.puppet'

    - name: start puppetserver
      service:
        name: puppetserver
        state: started

    - name: start puppet
      service:
        name: puppet
        state: started

    - name: add host my conf
      get_url:
        url: https://raw.githubusercontent.com/Stanisz1/devops-hometasks/master/03-puppet/autosign.conf 
        dest: /etc/puppetlabs/puppet/autosign.conf 
        mode: '0644'
    

    - name: download my r10k.yaml 
      get_url:
        url: https://raw.githubusercontent.com/Stanisz1/devops-hometasks/master/03-puppet/r10k.yaml
        dest: /etc/r10k.yaml 
        mode: '0644'  

    - name: activate r10k
      command: '/opt/puppetlabs/puppet/bin/r10k deploy environment -p'
      become: true
